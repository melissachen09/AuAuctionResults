#!/usr/bin/env node

const { execSync } = require('child_process');
const fs = require('fs');
const path = require('path');
const crypto = require('crypto');

console.log('ğŸš€ AU Auction Results - è‡ªåŠ¨éƒ¨ç½²è„šæœ¬');
console.log('=====================================\n');

// ç”Ÿæˆ API Secret
const generateApiSecret = () => {
  return crypto.randomBytes(32).toString('base64');
};

// æ‰§è¡Œå‘½ä»¤çš„è¾…åŠ©å‡½æ•°
const exec = (command, options = {}) => {
  try {
    return execSync(command, { 
      stdio: 'inherit',
      encoding: 'utf8',
      ...options 
    });
  } catch (error) {
    console.error(`âŒ å‘½ä»¤æ‰§è¡Œå¤±è´¥: ${command}`);
    process.exit(1);
  }
};

// æ£€æŸ¥æ˜¯å¦åœ¨é¡¹ç›®æ ¹ç›®å½•
const checkProjectRoot = () => {
  if (!fs.existsSync('package.json')) {
    console.error('âŒ è¯·åœ¨é¡¹ç›®æ ¹ç›®å½•è¿è¡Œæ­¤è„šæœ¬');
    process.exit(1);
  }
  console.log('âœ… é¡¹ç›®ç›®å½•æ£€æŸ¥é€šè¿‡\n');
};

// ç”Ÿæˆç¯å¢ƒå˜é‡
const generateEnvVars = () => {
  console.log('ğŸ” ç”Ÿæˆç¯å¢ƒå˜é‡...');
  const apiSecret = generateApiSecret();
  
  // åˆ›å»º .env.production
  const envContent = `# Generated by auto-deploy script
API_SECRET="${apiSecret}"
NODE_ENV="production"

# Database URL will be added automatically by Vercel Postgres
# DATABASE_URL will be set after creating Vercel Postgres

# App URL will be set after deployment
# NEXT_PUBLIC_APP_URL will be set after deployment
`;

  fs.writeFileSync('.env.production', envContent);
  console.log('âœ… ç¯å¢ƒå˜é‡å·²ç”Ÿæˆ\n');
  
  return { apiSecret };
};

// åˆ›å»º Vercel é…ç½®
const createVercelConfig = () => {
  console.log('ğŸ“ åˆ›å»º Vercel é…ç½®...');
  
  // æ£€æŸ¥ vercel.json æ˜¯å¦å·²å­˜åœ¨
  if (!fs.existsSync('vercel.json')) {
    const vercelConfig = {
      buildCommand: "prisma generate && next build",
      installCommand: "npm install",
      framework: "nextjs",
      outputDirectory: ".next",
      regions: ["syd1"],
      env: {
        DATABASE_URL: "@database_url",
        API_SECRET: "@api_secret",
        NODE_ENV: "production"
      },
      build: {
        env: {
          DATABASE_URL: "@database_url"
        }
      },
      functions: {
        "src/app/api/scrape/route.ts": {
          maxDuration: 300
        }
      }
    };
    
    fs.writeFileSync('vercel.json', JSON.stringify(vercelConfig, null, 2));
    console.log('âœ… vercel.json å·²åˆ›å»º');
  } else {
    console.log('â„¹ï¸  vercel.json å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º');
  }
  
  console.log('');
};

// ä¸»éƒ¨ç½²å‡½æ•°
const deploy = async () => {
  try {
    // æ­¥éª¤ 1: æ£€æŸ¥ç¯å¢ƒ
    checkProjectRoot();
    
    // æ­¥éª¤ 2: ç”Ÿæˆç¯å¢ƒå˜é‡
    const { apiSecret } = generateEnvVars();
    
    // æ­¥éª¤ 3: åˆ›å»º Vercel é…ç½®
    createVercelConfig();
    
    // æ­¥éª¤ 4: ç™»å½• Vercelï¼ˆå¦‚æœéœ€è¦ï¼‰
    console.log('ğŸ”‘ æ£€æŸ¥ Vercel ç™»å½•çŠ¶æ€...');
    try {
      execSync('vercel whoami', { stdio: 'pipe' });
      console.log('âœ… å·²ç™»å½• Vercel\n');
    } catch {
      console.log('éœ€è¦ç™»å½• Vercel...');
      exec('vercel login');
    }
    
    // æ­¥éª¤ 5: éƒ¨ç½²é¡¹ç›®
    console.log('ğŸš€ å¼€å§‹éƒ¨ç½²åˆ° Vercel...');
    console.log('è¯·æŒ‰ç…§æç¤ºæ“ä½œï¼š');
    console.log('- Set up and deploy: Y');
    console.log('- Which scope: é€‰æ‹©ä½ çš„è´¦å·');
    console.log('- Link to existing project?: N (å¦‚æœæ˜¯é¦–æ¬¡éƒ¨ç½²)');
    console.log('- Project name: au-auction-results (æˆ–è‡ªå®šä¹‰)');
    console.log('- In which directory: ./ (å½“å‰ç›®å½•)');
    console.log('- Want to modify settings?: N\n');
    
    // éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
    exec('vercel --prod');
    
    console.log('\nâœ… éƒ¨ç½²å®Œæˆï¼\n');
    
    // æ­¥éª¤ 6: è®¾ç½®ç¯å¢ƒå˜é‡
    console.log('ğŸ”§ è®¾ç½®ç”Ÿäº§ç¯å¢ƒå˜é‡...');
    exec(`vercel env add API_SECRET production < .env.production`);
    
    // æ­¥éª¤ 7: éƒ¨ç½²åæŒ‡å¼•
    console.log('\nğŸ“‹ éƒ¨ç½²åæ­¥éª¤ï¼š\n');
    console.log('1. åˆ›å»º Vercel Postgres æ•°æ®åº“ï¼š');
    console.log('   - è®¿é—® https://vercel.com/dashboard');
    console.log('   - é€‰æ‹©ä½ çš„é¡¹ç›®');
    console.log('   - ç‚¹å‡» "Storage" â†’ "Create Database" â†’ "Postgres"');
    console.log('   - é€‰æ‹© Sydney åŒºåŸŸ\n');
    
    console.log('2. è¿è¡Œæ•°æ®åº“è¿ç§»ï¼š');
    console.log('   vercel env pull .env.production.local');
    console.log('   npx prisma migrate deploy\n');
    
    console.log('3. é…ç½® GitHub Actions (å¯é€‰)ï¼š');
    console.log('   åœ¨ GitHub ä»“åº“ Settings â†’ Secrets ä¸­æ·»åŠ ï¼š');
    console.log(`   - API_SECRET: ${apiSecret}`);
    console.log('   - DATABASE_URL: (ä» Vercel å¤åˆ¶)');
    console.log('   - API_URL: (ä½ çš„ Vercel åº”ç”¨ URL)\n');
    
    console.log('4. æµ‹è¯•ä½ çš„åº”ç”¨ï¼š');
    console.log('   vercel open');
    
    // ä¿å­˜éƒ¨ç½²ä¿¡æ¯
    const deployInfo = {
      deployedAt: new Date().toISOString(),
      apiSecret: apiSecret,
      projectName: 'au-auction-results',
      tips: [
        'è¯·å¦¥å–„ä¿ç®¡ API_SECRET',
        'è®°å¾—åˆ›å»º Vercel Postgres æ•°æ®åº“',
        'è¿è¡Œæ•°æ®åº“è¿ç§»åæ‰èƒ½æ­£å¸¸ä½¿ç”¨'
      ]
    };
    
    fs.writeFileSync('deployment-info.json', JSON.stringify(deployInfo, null, 2));
    console.log('\nğŸ’¾ éƒ¨ç½²ä¿¡æ¯å·²ä¿å­˜åˆ° deployment-info.json');
    
  } catch (error) {
    console.error('\nâŒ éƒ¨ç½²å¤±è´¥:', error.message);
    process.exit(1);
  }
};

// æ¸…ç†å‡½æ•°
process.on('SIGINT', () => {
  console.log('\n\nğŸ›‘ éƒ¨ç½²å·²å–æ¶ˆ');
  process.exit(0);
});

// è¿è¡Œéƒ¨ç½²
deploy();